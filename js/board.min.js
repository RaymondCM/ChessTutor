function Init_Chessboard(){turnCount=0,fenHistory=[],drawScale(cb_counterScaleMarkings),SetTheme(cb_currentTheme),ct_debug||$("#Debug").css("display","none"),board="",game=new Chess;var a=function(e,a,r,t){return game.game_over()===!0||"w"===game.turn()&&-1!==a.search(/^b/)||"b"===game.turn()&&-1!==a.search(/^w/)||game.turn()!==game_playerSide?!1:void 0},r=function(){$("#Chessboard .square-55d63").css("background",""),board.highlightSquare(cb_permHighlighted,!0)};highlightSquare=function(e,a){var r,t;a?(r=cb_currentTheme.permWhitePossiblePlaces,t=cb_currentTheme.permBlackPossiblePlaces):(r=cb_currentTheme.whitePossiblePlaces,t=cb_currentTheme.blackPossiblePlaces);var o=$("#Chessboard .square-"+e),n=o.hasClass("black-3c85d")===!0?t:r;o.css("background",n)};var t=function(e,a){var r=game.moves({square:e,verbose:!0});if(game.turn()===game_playerSide&&0!==r.length){highlightSquare(e,!1);for(var t=0;t<r.length;t++)highlightSquare(r[t].to,!1)}},o=function(e,a){r()},n=function(){board.position(game.fen())},s={draggable:!0,position:"start",onDragStart:a,onDrop:MovePiece,onMouseoutSquare:o,onMouseoverSquare:t,onSnapEnd:n,pieceTheme:dir_pieceImages+"{piece}"+dir_pieceImagesExtension};board=ChessBoard("Chessboard",s),board.orientation("w"===game_playerSide?"white":"black"),turnCount++,updateStatus(),board.highlightSquare=function(e,a){for(x in e)highlightSquare(e[x],a)},board.highlightSquare(cb_permHighlighted,!0)}function MovePiece(e,a){var r=game.move({from:e,to:a,promotion:"q"});return null===r?"snapback":(board.position(game.fen()),turnCount++,void updateStatus())}function updateStatus(){checkForTaken(board.position()),updateDebugLog(),fenHistory.lengh<=cb_fenHistoryMaxLength?fenHistory.push(game.fen()):(fenHistory.shift(),fenHistory.push(game.fen())),AskEngine(game.fen(),sf_timeOverDepth?sf_searchTime:sf_searchDepth)}function piece(e){this.colourLetter=e.substr(0,1),this.nameletter=e.substr(1,2),this.colorWord="w"==e.substr(0,1)?"White":"Black",this.nameWord=pieces[e.substr(1,2)]}function updateScale(e){RoundedMax=function(e){var a=Math.max.apply(Math,e);if(0==a)return 0;var r=Math.floor(Math.log(Math.abs(a))/Math.LN10),t=Math.pow(10,r),o=Math.ceil(a/t)*t;return o},RoundedMin=function(e){var a=Math.min.apply(Math,e);if(0==a)return 0;var r=Math.floor(Math.log(Math.abs(a))/Math.LN10),t=Math.pow(10,r),o=Math.floor(a/t)*t;return o};var a=[sf_scoreBlack,0,sf_scoreWhite],r=RoundedMin(a),t=RoundedMax(a);document.getElementById("advLeft").innerHTML=r,document.getElementById("advMid").innerHTML=r+(t-r)/2,document.getElementById("advRight").innerHTML=t;var o=(sf_scoreWhite-r)/(t-r)*100,n=(sf_scoreBlack-r)/(t-r)*100;$("#advMarkerWhite").css("width",o+"%"),$("#advMarkerBlack").css("width",n+"%"),$("#advMarkerBlack p").html(sf_scoreBlack),$("#advMarkerWhite p").html(sf_scoreWhite)}function drawScale(e){for(var a=document,r=["advLower","advLowerMid","advUpperMid","advUpper"],t=a.createDocumentFragment(),o=0;o<r.length;o++){var n=a.createElement("div");n.className="advMarkers "+r[o]+" adv80",t.appendChild(n)}for(var s=t.childNodes,i=[],l=0;e>l;l++){i=[];for(var o=0;o<s.length;o++)for(var c=0;c<r.length;c++){var n=a.createElement("div");n.className="advMarkers "+r[c]+" adv55",s[o].appendChild(n),i.push(n)}s=i}a.getElementById("advScale").appendChild(t)}function checkForTaken(e){var a={wQ:0,wR:0,wB:0,wN:0,wP:0,wK:0,bQ:0,bR:0,bB:0,bN:0,bP:0,bK:0};for(var r in e)e.hasOwnProperty(r)&&a[e[r]]++;a.bP=8-a.bP,a.bR=2-a.bR,a.bN=2-a.bN,a.bB=2-a.bB,a.bQ=1-a.bQ,a.bK=1-a.bK,a.wP=8-a.wP,a.wR=2-a.wR,a.wN=2-a.wN,a.wB=2-a.wB,a.wQ=1-a.wQ,a.wK=1-a.wK;var t=a.wP+3*a.wB+3*a.wN+4*a.wR+9*a.wQ,o=a.bP+3*a.bB+3*a.bN+4*a.bR+9*a.bQ;relativeScore="w"==game_playerSide?o-t:t-o,updateScale();var n=document.getElementById(gui_blackCapturedId),s=document.getElementById(gui_whiteCapturedId);document.getElementById(gui_scoreBlackId).innerHTML="BLACK SCORE: "+t,document.getElementById(gui_scoreWhiteId).innerHTML="WHITE SCORE: "+o,document.getElementById(gui_scorePlayerId).innerHTML="YOUR "+("w"==game_playerSide?"(WHITE'S)":"(BLACK'S)")+" RELATIVE SCORE: "+relativeScore,n.innerHTML="CAPTURED BLACK PIECES: ",s.innerHTML="CAPTURED WHITE PIECES: ";for(var r in a)drawImg(dir_pieceImages+r+dir_pieceImagesExtension,"w"==r.charAt(0)?s:n,a[r])}function drawImg(e,a,r){var t=document.createElement("img");t.src=e,t.style.height=gui_capturedPieceSize,t.style.width=gui_capturedPieceSize;for(var o=0;r>o;o++)a.appendChild(t)}function updateDebugLog(){var e="",a="",r="",t="b"===game.turn()?"Black":"White";game.in_checkmate()===!0?r=t:game.in_draw()===!0?e="DRAW":(e=t,game.in_check()===!0&&(a=t)),$("#status").html("FEN: "+game.fen()+"<br><br>"),$("#fen").html("TURN: "+e),$("#check").html("COLOUR IN CHECK: "+a),$("#checkmate").html("COLOUR IN CHECKMATE: "+r)}function SetTheme(e){alterCSS(".square-55d63",cb_shapes[cb_currentTheme.boardShape]),cb_shapes[cb_currentTheme.boardShape]==cb_shapes.Diamond&&alterCSS(".square-55d63 img",cb_shapes.DiamondIMGFix),alterCSS(".white-1e1d7",e.whiteSquare,e.whiteSquareText),alterCSS(".black-3c85d",e.blackSquare,e.blackSquareText)}function alterCSS(e,a,r){var t="undefined"==typeof r||""===r?a:"background-color: "+a+"; color:"+r+";";$(e).removeProp?$(e).removeProp("background-color"):$(e).removeAttr("background-color");var o=$("#temp-css-store-c34jw2-f32r12");if(0==o.length){var o=$('<div id="temp-css-store-c34jw2-f32r12"></div>');o.hide(),o.appendTo($("body"))}classContainer=o.find('div[data-class="'+e+'"]'),0==classContainer.length&&(classContainer=$('<div data-class="'+e+'"></div>'),classContainer.appendTo(o)),classContainer.html("<style>"+e+" {"+t+"}</style>")}